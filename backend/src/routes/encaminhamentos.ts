// backend/src/routes/encaminhamentos.ts

import express, { Router, Request, Response, NextFunction } from 'express';
import pool from '../db';
import { authMiddleware } from '../middleware/auth/auth';
import { logAction } from '../services/logger';
import { unitAccessMiddleware } from '../middleware/unitAccess.middleware';
import { checkCaseAccess, checkItemAccessByParentCase } from '../middleware/caseAccess.middleware'; // ImportaÃ§Ãµes das checagens centralizadas

const router = express.Router();

// ðŸ“Œ SOLUÃ‡ÃƒO DE LIMPEZA EXTREMA: Essencial para remover o erro 'syntax error at or near " "'
const cleanSqlString = (sql: string): string => {
  return sql.replace(/\s+/g, ' ').trim();
};


// AplicaÃ§Ã£o do middleware de seguranÃ§a e filtro de unidade em todas as rotas
router.use(authMiddleware, unitAccessMiddleware('casos', 'unit_id'));


/**
 * @route Â  POST /api/encaminhamentos
 * @desc Â  Â Cria um novo encaminhamento para um caso (Checa acesso ao casoId no body)
 * @access Â Private
 */
router.post('/', checkCaseAccess('body', 'casoId'), async (req: Request, res: Response) => {
  const userId = req.user!.id;
  const username = req.user!.username;
  const { casoId, servicoDestino, dataEncaminhamento, observacoes } = req.body;
  const userUnitId = req.user!.unit_id;

  if (!casoId || !servicoDestino || !dataEncaminhamento) {
    return res.status(400).json({ message: 'Campos obrigatÃ³rios estÃ£o faltando.' });
  }

  try {
    const query = cleanSqlString(`
Â  Â  Â  INSERT INTO encaminhamentos
Â  Â  Â  Â  ("casoId", "userId", "servicoDestino", "dataEncaminhamento", observacoes)
Â  Â  Â  VALUES
Â  Â  Â  Â  ($1, $2, $3, $4, $5)
Â  Â  Â  RETURNING id, "servicoDestino";
Â  Â  `);
    const result = await pool.query(query, [casoId, userId, servicoDestino, dataEncaminhamento, observacoes]);
    const novoEncaminhamento = result.rows[0];

    await logAction({
      userId,
      username,
      action: 'CREATE_ENCAMINHAMENTO',
      details: {
        casoId,
        encaminhamentoId: novoEncaminhamento.id,
        servico: novoEncaminhamento.servicoDestino,
        unitId: userUnitId
      }
    });

    res.status(201).json({
      message: 'Encaminhamento registrado com sucesso!',
      encaminhamento: novoEncaminhamento
    });
  } catch (err: any) {
    console.error('Erro ao registrar encaminhamento:', err.message);
    res.status(500).json({ message: 'Erro no servidor ao registrar encaminhamento.' });
  }
});

/**
 * @route Â  PUT /api/encaminhamentos/:id
 * @desc Â  Â Atualiza o status e/ou data de retorno de um encaminhamento (Checa acesso ao casoId via encaminhamentoId)
 * @access Â Private
 */
router.put('/:id', checkItemAccessByParentCase('id', 'encaminhamentos'), async (req: Request, res: Response) => {
  const { id } = req.params;
  const { status, dataRetorno } = req.body;
  const { id: userId, username } = req.user!;
  const casoId = (req as any).casoId; // CasoId obtido do middleware

  if (!status) {
    return res.status(400).json({ message: 'O novo status Ã© obrigatÃ³rio.' });
  }

  try {
    const query = cleanSqlString(`
Â  Â  Â  UPDATE encaminhamentos
Â  Â  Â  SET 
Â  Â  Â  Â  status = $1,
Â  Â  Â  Â  "dataRetorno" = $2
Â  Â  Â  WHERE id = $3
Â  Â  Â  RETURNING id, "casoId", "servicoDestino";
Â  Â  `);
    const result = await pool.query(query, [status, dataRetorno, id]);

    if (result.rowCount === 0) {
      // Esta checagem Ã© redundante apÃ³s o middleware, mas mantida como fail-safe
      return res.status(404).json({ message: 'Encaminhamento nÃ£o encontrado.' });
    }

    const encaminhamentoAtualizado = result.rows[0];

    await logAction({
      userId,
      username,
      action: 'UPDATE_ENCAMINHAMENTO_STATUS',
      details: {
        casoId: casoId,
        encaminhamentoId: encaminhamentoAtualizado.id,
        servico: encaminhamentoAtualizado.servicoDestino,
        novoStatus: status,
        unitId: req.user!.unit_id
      }
    });

    res.json({ message: 'Status do encaminhamento atualizado com sucesso!' });

  } catch (err: any) {
    console.error(`Erro ao atualizar encaminhamento ${id}:`, err.message);
    res.status(500).json({ message: 'Erro no servidor ao atualizar encaminhamento.' });
  }
});

// A rota GET /api/casos/:casoId/encaminhamentos estÃ¡ no casos.ts

export default router;